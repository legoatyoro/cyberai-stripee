import { NextResponse } from "next/server";

const pentestResults = new Map();

export async function POST(request) {
  try {
    const body = await request.json();
    if (!body.sessionId || !body.target) return NextResponse.json({ error: "Missing sessionId or target" }, { status: 400 });
    pentestResults.set(body.sessionId, { source: body.source || "RedTeam Agent Pro", sessionId: body.sessionId, target: body.target, scanDate: body.scanDate || new Date().toISOString(), receivedAt: new Date().toISOString(), vulnerabilities: body.vulnerabilities || [], totalTests: body.totalTests || 0, verifiedVulns: body.verifiedVulns || 0 });
    console.log("[CYBERAI] Received: session=" + body.sessionId + " vulns=" + body.verifiedVulns);
    return NextResponse.json({ success: true, sessionId: body.sessionId, vulnsReceived: (body.vulnerabilities || []).length });
  } catch (err) { return NextResponse.json({ error: err.message }, { status: 500 }); }
}

export async function GET(request) {
  const { searchParams } = new URL(request.url);
  const sessionId = searchParams.get("sessionId");
  if (!sessionId) return NextResponse.json({ error: "sessionId required" }, { status: 400 });
  const results = pentestResults.get(sessionId);
  if (!results) return NextResponse.json({ error: "Session not found" }, { status: 404 });
  return NextResponse.json(results);
}
